<form [formGroup]="form">
  <div class="flex flex-col gap-2">
    <div class="df-tab-table-container d-flex flex-col !gap-3">
      <div class="df-tab-grid-container">
        <div class="table-container">
          <table mat-table [dataSource]="dataSource" class="mat-table" aria-describedby="[]">
            <ng-container *ngFor="let column of displayedColumns" [matColumnDef]="column">
              <th mat-header-cell *matHeaderCellDef [style.width.%]="columnConfig[column]?.width">
                <ng-container *ngIf="column !== 'marketComparison'; else marketComparisonHeader">
                  {{ columnConfig[column]?.displayName }}
                </ng-container>
                <ng-template #marketComparisonHeader>
                  <div class="inline-flex min-w-32">
                    <span class="notification w-full">
                      {{ columnConfig[column]?.displayName }}
                    </span>
                  </div>
                </ng-template>
              </th>
              <!-- Category column: group + children with indentation -->
              <ng-container *ngIf="column === 'overheadCategory'">
                <td
                  mat-cell
                  *matCellDef="let row"
                  class="supplier-table-row-def min-w-64"
                  [ngClass]="{
                    'parent-td': row.isGroup,
                    'child-td': !row.isGroup && row.parentKey,
                  }">
                  <!-- Parent rows: display normally -->
                  <ng-container *ngIf="row.isGroup">
                    <span class="parent-category">{{ row.overheadCategory }}</span>
                  </ng-container>

                  <!-- Child rows: use ul/li structure -->
                  <ng-container *ngIf="!row.isGroup && row.parentKey">
                    <ul class="desc-tree">
                      <li>{{ row.overheadCategory }}</li>
                    </ul>
                  </ng-container>

                  <!-- Standalone rows (no parent) -->
                  <ng-container *ngIf="!row.isGroup && !row.parentKey">
                    {{ row.overheadCategory }}
                  </ng-container>
                </td>
              </ng-container>
              <!-- Value column: input for leaf rows, blank for group rows -->
              <ng-container *ngIf="column === 'currentValue'">
                <td mat-cell *matCellDef="let row" class="supplier-table-row-def">
                  <ng-container *ngIf="!row.isGroup">
                    <div class="value-unit flex relative">
                      <input type="number" class="form-control text-left pr-5 min-w-24" formControlName="{{ row.overheadKey }}" placeholder="Enter value" />
                      <span class="unit">%</span>
                    </div>
                  </ng-container>
                </td>
              </ng-container>

              <!-- marketComparison column stays as is -->
              <ng-container *ngIf="column === 'marketComparison'">
                <td mat-cell *matCellDef="let row; let i = index" class="text-center">
                  <ng-container *ngIf="!row.isGroup">
                    <span class="flex justify-center align-items-center">
                      <!-- Green SVG (value < 5) -->
                      <ng-container *ngIf="getMarketComparisonColor(row) === 'green'">
                        <svg width="52" height="34" viewBox="0 0 52 34" fill="none" xmlns="http://www.w3.org/2000/svg">
                          <g clip-path="url(#clip0_8738_69134)">
                            <path
                              d="M3.54511 28.8969C3.54511 25.9618 4.12321 23.0555 5.24641 20.3439C6.3696 17.6323 8.01589 15.1684 10.0913 13.093C12.1667 11.0176 14.6305 9.37136 17.3421 8.24817C20.0538 7.12497 22.9601 6.54687 25.8951 6.54688C28.8302 6.54688 31.7365 7.12498 34.4481 8.24817C37.1597 9.37136 39.6236 11.0177 41.699 13.093C43.7743 15.1684 45.4206 17.6323 46.5438 20.3439C47.667 23.0555 48.2451 25.9618 48.2451 28.8969"
                              stroke="#E2E2E2"
                              stroke-width="7.5" />
                            <path
                              d="M3.54486 28.8969C3.54486 25.9618 4.12297 23.0555 5.24616 20.3439C6.36935 17.6323 8.01564 15.1684 10.091 13.093C12.1664 11.0176 14.6303 9.37136 17.3419 8.24817C20.0535 7.12497 22.9598 6.54687 25.8949 6.54688C28.8299 6.54688 31.7362 7.12498 34.4478 8.24817C37.1595 9.37136 39.6233 11.0177 41.6987 13.093C43.7741 15.1684 45.4204 17.6323 46.5436 20.3439C47.2614 22.0769 47.7566 23.8893 48.0205 25.738"
                              stroke="#2BA746"
                              stroke-width="7.1" />
                            <path d="M51.8854 25.7617L29.4696 26.8659L29.4922 24.2679L51.8854 25.7617Z" fill="black" />
                            <path
                              d="M26.7383 22.5469C28.3951 22.5469 29.7383 23.89 29.7383 25.5469C29.7383 27.2037 28.3951 28.5469 26.7383 28.5469C25.0814 28.5469 23.7383 27.2037 23.7383 25.5469C23.7383 23.89 25.0814 22.5469 26.7383 22.5469ZM26.7383 24.5469C26.186 24.5469 25.7383 24.9946 25.7383 25.5469C25.7383 26.0992 26.186 26.5469 26.7383 26.5469C27.2906 26.5469 27.7383 26.0992 27.7383 25.5469C27.7383 24.9946 27.2906 24.5469 26.7383 24.5469Z"
                              fill="black" />
                          </g>
                          <defs>
                            <clipPath id="clip0_8738_69134">
                              <rect width="52" height="34" fill="white" />
                            </clipPath>
                          </defs>
                        </svg>
                      </ng-container>
                      <ng-container *ngIf="getMarketComparisonColor(row) === 'yellow'">
                        <svg width="52" height="34" viewBox="0 0 52 34" fill="none" xmlns="http://www.w3.org/2000/svg">
                          <g clip-path="url(#clip0_8738_69170)">
                            <path
                              d="M3.54511 28.8969C3.54511 25.9618 4.12321 23.0555 5.24641 20.3439C6.3696 17.6323 8.01589 15.1684 10.0913 13.093C12.1667 11.0176 14.6305 9.37136 17.3421 8.24817C20.0538 7.12497 22.9601 6.54687 25.8951 6.54688C28.8302 6.54688 31.7365 7.12498 34.4481 8.24817C37.1597 9.37136 39.6236 11.0177 41.699 13.093C43.7743 15.1684 45.4206 17.6323 46.5438 20.3439C47.667 23.0555 48.2451 25.9618 48.2451 28.8969"
                              stroke="#E2E2E2"
                              stroke-width="7.5" />
                            <path
                              d="M3.54527 28.8969C3.54527 25.9618 4.12337 23.0555 5.24656 20.3439C6.36975 17.6323 8.01604 15.1684 10.0914 13.093C12.1668 11.0176 14.6307 9.37136 17.3423 8.24817C20.0539 7.12497 22.9602 6.54687 25.8953 6.54688C28.8303 6.54688 31.7366 7.12498 34.4482 8.24817"
                              stroke="#F9D645"
                              stroke-width="7.1" />
                            <path d="M36.0851 4.60586L28.4884 25.0274L26.1117 23.9781L36.0851 4.60586Z" fill="black" />
                            <path
                              d="M26.7373 22.5469C28.3942 22.5469 29.7373 23.89 29.7373 25.5469C29.7373 27.2037 28.3942 28.5469 26.7373 28.5469C25.0805 28.5469 23.7373 27.2037 23.7373 25.5469C23.7373 23.89 25.0805 22.5469 26.7373 22.5469ZM26.7373 24.5469C26.185 24.5469 25.7373 24.9946 25.7373 25.5469C25.7373 26.0992 26.185 26.5469 26.7373 26.5469C27.2896 26.5469 27.7373 26.0992 27.7373 25.5469C27.7373 24.9946 27.2896 24.5469 26.7373 24.5469Z"
                              fill="black" />
                          </g>
                          <defs>
                            <clipPath id="clip0_8738_69170">
                              <rect width="52" height="34" fill="white" />
                            </clipPath>
                          </defs>
                        </svg>
                      </ng-container>
                      <ng-container *ngIf="getMarketComparisonColor(row) === 'red'">
                        <svg width="52" height="34" viewBox="0 0 52 34" fill="none" xmlns="http://www.w3.org/2000/svg">
                          <g clip-path="url(#clip0_8738_69158)">
                            <path
                              d="M3.54804 28.8969C3.54804 25.9618 4.12614 23.0555 5.24934 20.3439C6.37253 17.6323 8.01882 15.1684 10.0942 13.093C12.1696 11.0176 14.6334 9.37136 17.3451 8.24817C20.0567 7.12497 22.963 6.54687 25.898 6.54688C28.8331 6.54688 31.7394 7.12498 34.451 8.24817C37.1626 9.37136 39.6265 11.0177 41.7019 13.093C43.7773 15.1684 45.4236 17.6323 46.5468 20.3439C47.6699 23.0555 48.248 25.9618 48.248 28.8969"
                              stroke="#E2E2E2"
                              stroke-width="7.5" />
                            <path
                              d="M3.54847 28.8957C3.54847 25.9606 4.12658 23.0543 5.24977 20.3427C6.37296 17.6311 8.01925 15.1672 10.0946 13.0918C10.5076 12.6789 10.9359 12.2829 11.3785 11.9047C11.4192 11.8699 11.46 11.8353 11.501 11.8008"
                              stroke="#C1272D"
                              stroke-width="7.5" />
                            <path d="M9.05314 9.06892L23.6412 25.2535L25.4639 23.402L9.05314 9.06892Z" fill="black" />
                            <path
                              d="M25.7207 22.5469C24.0638 22.5469 22.7207 23.89 22.7207 25.5469C22.7207 27.2037 24.0638 28.5469 25.7207 28.5469C27.3776 28.5469 28.7207 27.2037 28.7207 25.5469C28.7207 23.89 27.3776 22.5469 25.7207 22.5469ZM25.7207 24.5469C26.273 24.5469 26.7207 24.9946 26.7207 25.5469C26.7207 26.0992 26.273 26.5469 25.7207 26.5469C25.1684 26.5469 24.7207 26.0992 24.7207 25.5469C24.7207 24.9946 25.1684 24.5469 25.7207 24.5469Z"
                              fill="black" />
                          </g>
                          <defs>
                            <clipPath id="clip0_8738_69158">
                              <rect width="52" height="34" fill="white" />
                            </clipPath>
                          </defs>
                        </svg>
                      </ng-container>
                    </span>
                  </ng-container>
                </td>
              </ng-container>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr
              mat-row
              *matRowDef="let row; columns: displayedColumns"
              [ngClass]="{
                'parent-row': row.isGroup,
                'child-row': !row.isGroup && row.parentKey,
              }"></tr>
          </table>
        </div>
      </div>
    </div>
  </div>
</form>
<app-edit-toolbar [canUndo]="canUndo()" [canRedo]="canRedo()" [dirty]="isDirty()" (undo)="undo()" (redo)="redo()" (save)="save()" (discard)="discard()"></app-edit-toolbar>
