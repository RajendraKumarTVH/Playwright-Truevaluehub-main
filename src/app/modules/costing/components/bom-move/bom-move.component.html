<div class="modal-header flex items-center justify-between">
  <h4 class="modal-title" id="modal-basic-title">Select Purchase Parts(s)</h4>
  <button aria-label="Close modal" title="Close" class="modal-close flex items-center justify-center border-none bg-white" (click)="dismissAll()">
    <mat-icon class="close-icon" matTooltip="Close" matTooltipPosition="above">close_icon</mat-icon>
  </button>
</div>
<div class="modal-body flex flex-col h-full min-h-0 gap-2">
  <div class="search-bar">
    <div class="search-icon-wrap absolute flex items-center justify-center border-none bg-white h-full">
      <mat-icon class="search-icon" svgIcon="find-icon">find-icon</mat-icon>
    </div>
    <input type="text" class="w-full" pInputText placeholder="Search" [(ngModel)]="globalFilter" (ngModelChange)="tt.filterGlobal($event, 'contains')" />
    <button
      *ngIf="globalFilter"
      class="clear-search-cta absolute flex items-center justify-center border-none bg-white"
      title="Clear search"
      matTooltip="Clear"
      matTooltipPosition="above"
      aria-label="Clear search"
      (click)="clearSearch()">
      <mat-icon class="clear-icon" svgIcon="close_icon">close_icon</mat-icon>
    </button>
  </div>
  <div class="rounded-md border-solid move-modal-tree overflow-hidden tree-wrap flex flex-col h-full min-h-0">
    <p-treetable
      #tt
      [value]="treeViewData"
      [filters]="{ global: { value: globalFilter, matchMode: 'contains' } }"
      [globalFilterFields]="['name']"
      [columns]="cols"
      dataKey="key"
      filterMode="lenient"
      [scrollable]="true"
      [tableStyle]="{ 'min-width': '50rem' }">
      <ng-template #header let-columns>
        <tr>
          <th *ngFor="let col of columns" scope="row" [ngClass]="col.cssClass">
            {{ col.header }}
          </th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-rowNode let-rowData="rowData" let-columns="columns">
        <tr [ttRow]="rowNode">
          <td *ngFor="let col of columns; let i = index" [ngClass]="col.cssClass">
            <ng-container [ngSwitch]="col.field">
              <ng-container *ngSwitchCase="'name'">
                <div class="row-controls flex items-center gap-2">
                  <p-checkbox
                    [style.visibility]="rowNode.node.parent ? 'visible' : 'hidden'"
                    [binary]="true"
                    [ngModel]="selectionKeys[rowNode.node.key]?.checked"
                    [disabled]="rowNode.node.disabled || rowNode.node.parent?.data?.isPartMoved"
                    (onChange)="onCheckboxChange($event, rowNode.node)"></p-checkbox>
                  @if (!(rowData.children.length === 0 && rowData.level === 0)) {
                    <p-treetable-toggler (click)="onToggleClick($event)" [rowNode]="rowNode" class="mr-2" />
                  }
                  <span class="flex h-4 w-4" role="presentation" [ngClass]="rowData.icon"></span>
                  {{ rowData.name }}
                  <mat-icon class="move-icon" *ngIf="rowData.isPartMoved" svgIcon="moved-icon"></mat-icon>
                  <ng-container *ngIf="!rowData.isPartMoved">
                    <div class="flex items-center gap-2">
                      <app-progress-bar
                        class="flex items-center justify-center shrink-0 treeview-progress rounded-full h-5 w-5 bg-white p-0"
                        [percentage]="rowData.dataCompletionPercentage || 0"
                        [mode]="'donut'"
                        [showPercentageText]="false"
                        [animation]="false"></app-progress-bar>
                    </div>
                  </ng-container>
                </div>
              </ng-container>
              <ng-container *ngSwitchCase="'thumbnailImage'">
                <ng-container *ngIf="rowData.thumbnailImage">
                  <button class="thumb-wrap w-full h-full bg-white flex items-center justify-center" (click)="onPartThumbnailClick(rowData.partInfoId)">
                    <img class="treeview-image bg-white w-full h-full" [src]="'data:image/jpeg;base64,' + rowData.thumbnailImage" alt="Thumbnail" />
                  </button>
                </ng-container>
                <ng-container *ngIf="!rowData.thumbnailImage">
                  <div class="placeholder-thumb"></div>
                </ng-container>
              </ng-container>
            </ng-container>
          </td>
        </tr>
      </ng-template>
      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="2" class="text-center">No results found</td>
        </tr>
      </ng-template>
    </p-treetable>
  </div>
  <div class="d-flex items-center justify-content-end">
    <button class="btn min-w-32 mt-2 border-primary text-primary bg-transparent me-2" (click)="dismissAll()">Cancel</button>
    <button class="btn min-w-32 mt-2 btn-primary" [disabled]="isMoveDisabled" (click)="onMove()">Move</button>
  </div>
</div>
