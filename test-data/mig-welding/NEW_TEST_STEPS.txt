// NEW TEST STEPS TO ADD TO costing_mig-welding.spec.ts
// Add these after Step 8

test('Step 9: Verify Cost Breakdown and Net Process Cost', async () => {
	if (hasFailed) test.skip()
	try {
		logger.info('üîπ Step 9: Verify Cost Breakdown and Net Process Cost')

		// Navigate to cost section
		await migWeldingPage.Cost.scrollIntoViewIfNeeded()
		await migWeldingPage.Cost.click()
		await page.waitForTimeout(1000)

		// Get actual cost values from UI
		const actualCosts = {
			materialCost: await migWeldingPage.getInputValueAsNumber(migWeldingPage.MaterialCost),
			manufacturingCost: await migWeldingPage.getInputValueAsNumber(migWeldingPage.ManufacturingCost),
			toolingCost: await migWeldingPage.getInputValueAsNumber(migWeldingPage.ToolingCost),
			overheadProfit: await migWeldingPage.getInputValueAsNumber(migWeldingPage.OverheadProfit),
			packingCost: await migWeldingPage.getInputValueAsNumber(migWeldingPage.PackingCost),
			exwPartCost: await migWeldingPage.getInputValueAsNumber(migWeldingPage.ExwPartCost),
			freightCost: await migWeldingPage.getInputValueAsNumber(migWeldingPage.FreightCost),
			dutiesTariff: await migWeldingPage.getInputValueAsNumber(migWeldingPage.DutiesTariff),
			partShouldCost: await migWeldingPage.getInputValueAsNumber(migWeldingPage.PartShouldCost)
		}

		logger.info(`Cost Breakdown: ${JSON.stringify(actualCosts, null, 2)}`)

		// Verify cost values (with tolerance for rounding)
		expect.soft(actualCosts.materialCost).toBeCloseTo(0.007, 3)
		expect.soft(actualCosts.manufacturingCost).toBeCloseTo(0.1517, 3)
		expect.soft(actualCosts.toolingCost).toBe(0)
		expect.soft(actualCosts.overheadProfit).toBeCloseTo(0.0205, 3)
		expect.soft(actualCosts.packingCost).toBeCloseTo(0.0009, 3)
		expect.soft(actualCosts.exwPartCost).toBeCloseTo(0.1801, 3)
		expect.soft(actualCosts.freightCost).toBeCloseTo(0.0002, 3)
		expect.soft(actualCosts.dutiesTariff).toBe(0)
		expect.soft(actualCosts.partShouldCost).toBeCloseTo(0.1803, 3)

		// Verify Manufacturing Cost = Net Process Cost
		// Formula: directMachineCost + directLaborCost + directSetUpCost + inspectionCost + yieldCost + totalPowerCost
		const netProcessCost = actualCosts.manufacturingCost
		logger.info(`Net Process Cost (Manufacturing Cost): $${netProcessCost}`)
		
		expect(netProcessCost).toBeGreaterThan(0)
		
		logger.info('‚úÖ Cost Breakdown Verified')
	} catch (err: any) {
		hasFailed = true
		logger.error(`‚ùå Step 9 Failed: ${err.message}`)
		throw err
	}
})

test('Step 10: Verify ESG Calculations', async () => {
	if (hasFailed) test.skip()
	try {
		logger.info('üîπ Step 10: Verify ESG Calculations')

		// Navigate to ESG section
		await migWeldingPage.ESG.scrollIntoViewIfNeeded()
		await migWeldingPage.ESG.click()
		await page.waitForTimeout(1000)

		// Get ESG values
		const totalPartESG = await migWeldingPage.getInputValueAsNumber(migWeldingPage.TotalPartESG)
		const annualESG = await migWeldingPage.getInputValueAsNumber(migWeldingPage.AnnualESG)
		const lifetimeESG = await migWeldingPage.getInputValueAsNumber(migWeldingPage.LifetimeESG)

		logger.info(`ESG Metrics:`)
		logger.info(`  Total Part ESG: ${totalPartESG} kgCO2`)
		logger.info(`  Annual ESG: ${annualESG} kgCO2`)
		logger.info(`  Lifetime ESG: ${lifetimeESG} kgCO2`)

		// Verify ESG calculations
		// Total Part ESG = Material CO2 + Manufacturing CO2
		const expectedTotalPartESG = 0.585
		expect.soft(totalPartESG).toBeCloseTo(expectedTotalPartESG, 2)

		// Annual ESG = Total Part ESG * Annual Volume
		const annualVolume = MigWeldingTestData.partInformation.annualVolumeQty
		const expectedAnnualESG = totalPartESG * annualVolume
		expect.soft(annualESG).toBeCloseTo(expectedAnnualESG, 0) // No decimals for large numbers

		// Lifetime ESG = Annual ESG * Product Life
		const productLife = MigWeldingTestData.partInformation.productLifeRemaining
		const expectedLifetimeESG = annualESG * productLife
		expect.soft(lifetimeESG).toBeCloseTo(expectedLifetimeESG, 0)

		logger.info('‚úÖ ESG Calculations Verified')
	} catch (err: any) {
		hasFailed = true
		logger.error(`‚ùå Step 10 Failed: ${err.message}`)
		throw err
	}
})
